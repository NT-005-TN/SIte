<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Управление задачами</title>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="index.html">Главная</a></li>
                <li><a href="cybernetics.html">Кибернетика</a></li>
                <li><a href="mathematics.html">Математика</a></li>
                <li><a href="physics.html">Физика</a></li>
                <li><a href="humanities.html">Гуманитарные предметы</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <h1>Управление задачами</h1>

        <div class="form-group">
            <label for="subject">Выберите предмет:</label>
            <select id="subject">
                <option value="humanities">Гуманитарные</option>
                <option value="cybernetics">Кибернетика</option>
                <option value="mathematics">Математика</option>
                <option value="physics">Физика</option>
            </select>
        </div>

        <div class="form-group">
            <h2>Создать задачу:</h2>
            <form id="taskForm">
                <input type="text" id="task" required placeholder="Введите задачу">
                <input type="file" id="image" accept="image/*">
                <button type="submit">Создать задачу</button>
            </form>
        </div>

        <div class="form-group">
            <h2>Список задач:</h2>
            <ul id="taskList"></ul>
        </div>

        <button id="saveTasksButton">Сохранить задачи в файл</button> <!-- Кнопка для сохранения задач -->
        
        <div class="form-group">
            <h2>Загрузить задачи из файла:</h2>
            <input type="file" id="fileInput" accept=".json"> <!-- Поле для загрузки файла -->
        </div>
    </main>
    <footer>
        <p>Сайт помощник. 2024</p>
    </footer>

    <script>
        const taskForm = document.getElementById('taskForm');
        const taskList = document.getElementById('taskList');
        const subjectSelect = document.getElementById('subject');
        const fileInput = document.getElementById('fileInput');
        let editingIndex = -1; // Индекс редактируемой задачи

        // Load tasks from Local Storage for selected subject
        function loadTasks() {
            const subject = subjectSelect.value;
            const tasks = JSON.parse(localStorage.getItem(subject)) || [];
            displayTasks(tasks);
        }

        // Display tasks
        function displayTasks(tasks) {
            taskList.innerHTML = '';
            tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.innerHTML = `${task.text} 
                    <img src="${task.image}" alt="Изображение задачи" style="max-width: 100px; max-height: 100px;"> 
                    <button onclick="editTask(${index})">Редактировать</button>
                    <button onclick="deleteTask(${index})">Удалить</button>`;
                taskList.appendChild(li);
            });
        }

        // Add new task
        taskForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const taskInput = document.getElementById('task');
            const imageInput = document.getElementById('image');
            const subject = subjectSelect.value;
            const tasks = JSON.parse(localStorage.getItem(subject)) || [];
            
            const taskData = {
                text: taskInput.value,
                image: ''
            };

            // Handle image upload
            if (imageInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    taskData.image = e.target.result; // Сохраняем изображение в base64
                    saveTask(tasks, taskData);
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                saveTask(tasks, taskData);
            }
        });

        function saveTask(tasks, taskData) {
            if (editingIndex === -1) {
                tasks.push(taskData); // Добавление новой задачи
            } else {
                tasks[editingIndex] = taskData; // Обновление существующей задачи
                editingIndex = -1; // Сброс индекса редактирования
            }
            localStorage.setItem(subjectSelect.value, JSON.stringify(tasks));
            document.getElementById('task').value = '';
            document.getElementById('image').value = ''; // Сброс поля загрузки изображения
            loadTasks();
        }

        // Edit task
        function editTask(index) {
            const subject = subjectSelect.value;
            const tasks = JSON.parse(localStorage.getItem(subject)) || [];
            document.getElementById('task').value = tasks[index].text;
            editingIndex = index; // Устанавливаем индекс редактирования
        }

        // Delete task
        function deleteTask(index) {
            const subject = subjectSelect.value;
            const tasks = JSON.parse(localStorage.getItem(subject)) || [];
            tasks.splice(index, 1); // Удаляем задачу
            localStorage.setItem(subject, JSON.stringify(tasks));
            loadTasks();
        }

        // Load tasks on page load
        window.onload = loadTasks;

        // Update tasks when subject changes
        subjectSelect.addEventListener('change', loadTasks);

        // Save tasks to file
        document.getElementById('saveTasksButton').addEventListener('click', function() {
            const subject = subjectSelect.value;
            const tasks = JSON.parse(localStorage.getItem(subject)) || [];
            const blob = new Blob([JSON.stringify(tasks, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${subject}_tasks.json`; // Имя файла
            a.click();
            URL.revokeObjectURL(url); // Освобождение URL
        });

        // Load tasks from JSON file
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = JSON.parse(e.target.result);
                    const subject = subjectSelect.value;
                    const existingTasks = JSON.parse(localStorage.getItem(subject)) || [];
                    const updatedTasks = existingTasks.concat(data); // Объединяем существующие задачи с загруженными
                    localStorage.setItem(subject, JSON.stringify(updatedTasks)); // Сохраняем обновленные задачи
                    loadTasks(); // Перезагружаем задачи на странице
                };
                reader.readAsText(file);
            }
        });
    </script>
</body>
</html>